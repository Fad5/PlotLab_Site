{% extends "analysis/base.html" %}
{% load static %}

{% block page_title %}–ü—É–ª—å—Å–∞—Ç–æ—Ä{% endblock %}

{% block content %}
  <form method="post" enctype="multipart/form-data" class="upload-section">
    {% csrf_token %}
    <label><strong>üìÅ –ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª —Å –¥–∞–Ω–Ω—ã–º–∏ (.alc):</strong></label>
    <label for="csvFile" class="btn-download">üìÅ –í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª—ã</label>
    <input class="input-file" type="file" name="csv_file" id="csvFile" accept=".alc" multiple required>
    <button type="submit">–ü–æ—Å—Ç—Ä–æ–∏—Ç—å –≥—Ä–∞—Ñ–∏–∫–∏</button>
    {% if error %}
      <div class="error">{{ error }}</div>
    {% endif %}
  </form>

  <div class="plot-container" id="plot-container"></div>
{% endblock %}

{% block script %}
<script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
<script>
  const rawDatasets = {{ datasets|default:"[]"|safe }};
  const body = document.body;

  function getPlotlyLayoutOverrides() {
    const styles = getComputedStyle(document.body);
    return {
      template: "plotly_dark",
      font: { color: styles.getPropertyValue("--text-color").trim() },
      plot_bgcolor: styles.getPropertyValue("--box-bg").trim(),
      paper_bgcolor: styles.getPropertyValue("--box-bg").trim(),
      xaxis: {
        gridcolor: styles.getPropertyValue("--grid-color").trim(),
        color: styles.getPropertyValue("--text-color").trim()
      },
      yaxis: {
        gridcolor: styles.getPropertyValue("--grid-color").trim(),
        color: styles.getPropertyValue("--text-color").trim()
      }
    };
  }

  function downsampleData(x, y, maxPoints = 5000) {
    if (x.length <= maxPoints) return { x, y };

    const ratio = Math.ceil(x.length / maxPoints);
    const newX = [], newY = [];

    for (let i = 0; i < x.length; i += ratio) {
      newX.push(x[i]);
      newY.push(y[i]);
    }

    return { x: newX, y: newY };
  }

  function renderPlot(index, plot) {
    const div = document.getElementById(`plot-${index}`);
    const xTitle = plot.xaxis_title || "";
    const yTitle = plot.yaxis_title || "";

    const layout = {
      title: plot.title || `–ì—Ä–∞—Ñ–∏–∫ ${index + 1}`,
      xaxis: { title: xTitle },
      yaxis: { title: yTitle },
      margin: { t: 50, l: 50, r: 50, b: 50 },
      ...getPlotlyLayoutOverrides()
    };

    const originalX = plot.x;
    const originalY = plot.y;
    const downsampled = downsampleData(originalX, originalY);

    const trace = {
      x: downsampled.x,
      y: downsampled.y,
      type: 'scattergl',
      mode: 'lines',
      line: { width: 1 },
      marker: {
        color: getComputedStyle(document.body).getPropertyValue("--plot-color").trim()
      }
    };

    Plotly.newPlot(div, [trace], layout, { responsive: true }).then(() => {
      div._original = { x: originalX, y: originalY };

      div.on('plotly_relayout', (eventData) => {
        if (!eventData["xaxis.range[0]"]) return;

        const [x0, x1] = [parseFloat(eventData["xaxis.range[0]"]), parseFloat(eventData["xaxis.range[1]"])];
        const fullX = div._original.x;
        const fullY = div._original.y;

        const indices = [];
        for (let i = 0; i < fullX.length; i++) {
          if (fullX[i] >= x0 && fullX[i] <= x1) indices.push(i);
        }

        const maxPoints = 5000;
        const stride = Math.ceil(indices.length / maxPoints) || 1;
        const newX = [], newY = [];

        for (let i = 0; i < indices.length; i += stride) {
          newX.push(fullX[indices[i]]);
          newY.push(fullY[indices[i]]);
        }

        Plotly.update(div, {
          x: [newX],
          y: [newY]
        });
      });
    });
  }

  function setupLazyRendering() {
    const observer = new IntersectionObserver((entries, obs) => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          const div = entry.target;
          const index = parseInt(div.dataset.index, 10);
          if (!div.dataset.rendered) {
            renderPlot(index, rawDatasets[index]);
            div.dataset.rendered = "true";
          }
          obs.unobserve(div);
        }
      });
    }, { threshold: 0.1 });

    rawDatasets.forEach((plot, index) => {
      const div = document.createElement("div");
      div.className = "plot";
      div.id = `plot-${index}`;
      div.dataset.index = index;
      div.style.height = "400px";
      document.getElementById("plot-container").appendChild(div);
      observer.observe(div);
    });
  }

  document.addEventListener("DOMContentLoaded", function() {
    if (rawDatasets && rawDatasets.length > 0) {
      setupLazyRendering();
    }
  });
</script>
{% endblock %}