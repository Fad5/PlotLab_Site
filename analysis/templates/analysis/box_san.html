{% extends "analysis/base.html" %}
{% load static %}

{% block page_title %}–ö–æ—Ä–æ–±–æ—á–∫–∞{% endblock %}

{% block content %}
  <form method="post" id="Form" enctype="multipart/form-data" class="upload-section">
    {% csrf_token %}
    <label><strong>üìÅ –ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª —Å –¥–∞–Ω–Ω—ã–º–∏ (TXT):</strong></label>
    <label for="csvFile" class="btn-download transition_3">üìÅ –í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª—ã</label>
    <input class="input-file transition_3" type="file" name="csv_file" id="csvFile" accept=".txt" value="{{ filename.filename}}" required />
    <button class="transition_3" type="submit">–ü–æ—Å—Ç—Ä–æ–∏—Ç—å –≥—Ä–∞—Ñ–∏–∫–∏</button>
    {% if error %}
      <div class="error">{{ error }}</div>
    {% endif %}
  </form>

  {% if filename.filename %}
  <div class="filename-display">
    <strong>–¢–µ–∫—É—â–∏–π —Ñ–∞–π–ª:</strong> {{ filename.filename }}
  </div>
  {% endif %}

  <div class="plot-container" id="plot-container"></div>
{% endblock %}

{% block script %}
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script>
  const datasets = {{ datasets|default:"[]"|safe }};
  const body = document.body;

  function getPlotlyLayoutOverrides(theme) {
    const styles = getComputedStyle(document.body);
    return {
      template: "plotly_dark",
      font: { color: styles.getPropertyValue("--text-color").trim() },
      plot_bgcolor: styles.getPropertyValue("--box-bg").trim(),
      paper_bgcolor: styles.getPropertyValue("--box-bg").trim(),
      xaxis: {
        gridcolor: styles.getPropertyValue("--grid-color").trim(),
        color: styles.getPropertyValue("--text-color").trim()
      },
      yaxis: {
        gridcolor: styles.getPropertyValue("--grid-color").trim(),
        color: styles.getPropertyValue("--text-color").trim()
      }
    };
  }

  function drawPlots() {
    const container = document.getElementById("plot-container");
    container.innerHTML = "";

    if (!Array.isArray(datasets) || datasets.length === 0) return;

    datasets.forEach((plot, index) => {
      const div = document.createElement("div");
      div.className = "plot";
      div.id = `plot-${index}`;
      container.appendChild(div);

      Plotly.newPlot(div.id, [{
        x: plot.x,
        y: plot.y,
        type: 'scatter',
        mode: 'lines',
        marker: { color: getComputedStyle(document.body).getPropertyValue("--plot-color").trim() }
      }], {
        title: plot.title,
        xaxis: { title: plot.xaxis_title },
        yaxis: { title: plot.yaxis_title },
        margin: { t: 50, l: 50, r: 50, b: 50 },
        ...getPlotlyLayoutOverrides("dark")
      }, { responsive: true });
    });
  }

  document.addEventListener("DOMContentLoaded", drawPlots);
</script>

<script>
  document.querySelector('#Form').addEventListener('submit', function(e) {
    if (!document.getElementById('csvFile').files.length) {
      e.preventDefault();
      const errorElement = document.createElement('div');
      errorElement.textContent = '–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –≤ —Ñ–æ—Ä–º–∞—Ç–µ .txt';
      errorElement.style.color = 'red';
      document.getElementById('csvFile').after(errorElement);
    }
  });
</script>
{% endblock %}