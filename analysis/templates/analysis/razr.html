<!-- templates/analysis/tensile_test.html -->
{% extends "analysis/base.html" %}
{% load static %}

{% block page_title %}–ò—Å–ø—ã—Ç–∞–Ω–∏—è –Ω–∞ —Ä–∞–∑—Ä—ã–≤{% endblock %}

{% block style %}
<script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
<style>
  .glass-container {
    background: var(--box-bg);
    border-radius: 20px;
    border: 1px solid rgba(255, 255, 255, 0.2);
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.25);
    backdrop-filter: blur(10px);
    width: 90%;
    max-width: 1200px;
    padding: 2rem;
    margin-bottom: 2rem;
  }
  
  .plot-container {
    display: flex;
    flex-direction: column;
    gap: 30px;
    margin-top: 2rem;
    width: 100%;
  }

  .plot {
    width: 100%;
    height: 350px;
    background: var(--box-bg);
    border-radius: 10px;
    padding: 15px;
  }

  
  .input-sample {
    border: solid 3px var(--text-color);
    background: var(--input-bg);
    color: var(--text-color);
    width: 100%;
    padding: 8px;
    border-radius: 8px;
  }

  .results-container {
    margin-top: 2rem;
    border-radius: 20px;
    padding: 1.5rem;
  }
  
  .results-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
    gap: 1rem;
    margin-top: 1rem;
  }
  
  .result-item {
    background: rgba(255, 255, 255, 0.1);
    padding: 1rem;
    border-radius: 10px;
    border-left: 4px solid var(--accent-color);
  }
  
  label {
    display: block;
    margin-bottom: 5px;
    font-weight: bold;
  }
  
  .result-value {
    font-size: 1.2rem;
    font-weight: bold;
    color: var(--accent-color);
  }

  .parameter-group {
    display: flex;
    flex-direction: column;
    min-width: 200px;
  }

  .name-methodology {
    text-align: center;
  }
  
  .parameters-section {
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
    justify-content: center;
    margin-bottom: 1.5rem;
  }
  
  .methodology-section {
    background: var(--box-bg);
    border-radius: 20px;
    padding: 2rem;
    margin-top: 2rem;
  }
  
  .math-formula {
    margin: 1rem 0;
    padding: 1rem;
    background: rgba(255, 255, 255, 0.05);
    border-radius: 10px;
  }
  
  .algorithm-steps {
    padding-left: 1.5rem;
  }
  
  .standard-reference {
    font-style: italic;
    color: var(--text-secondary);
    margin-top: 10px;
  }
  
  .parameter-table {
    width: 100%;
    border-collapse: collapse;
    margin: 15px 0;
  }
  
  .parameter-table th, .parameter-table td {
    border: 1px solid var(--text-color);
    padding: 8px;
    text-align: left;
  }
  
  .text-center {
    text-align: center;
  }
  
  @media (max-width: 768px) {
    .results-grid {
      grid-template-columns: 1fr;
    }
  }
</style>
{% endblock %}

{% block content %}
<div class="glass-container">
  <form method="post" enctype="multipart/form-data" class="upload-section">
    {% csrf_token %}
    <h2 class="text-center">–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –æ–±—Ä–∞–∑—Ü–∞</h2>
    <div class="parameters-section">
      <div class="parameter-group">
        <label for="height">–ù–∞—á–∞–ª—å–Ω–∞—è –¥–ª–∏–Ω–∞ –æ–±—Ä–∞–∑—Ü–∞ L<sub>0</sub> (–º–º):</label>
        <input class="input-sample" type="number" step="0.1" name="height" id="height" value="{{ form_data.height|default:'80.0' }}" required />
      </div>
      <div class="parameter-group">
        <label for="area">–ü–ª–æ—â–∞–¥—å —Å–µ—á–µ–Ω–∏—è A<sub>0</sub> (–º–º¬≤):</label>
        <input class="input-sample" type="number" step="0.01" name="area" id="area" value="{{ form_data.area|default:'40.0' }}" required />
      </div>
    </div>
    
    <label><strong>üìÅ –ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª —Å –¥–∞–Ω–Ω—ã–º–∏ (TXT):</strong></label>
    <label for="csvFile" class="btn-download transition_3">üìÅ –í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª—ã</label>
    <input class="input-file transition_3" type="file" name="csv_file" id="csvFile" accept=".txt" value="{{ filename.filename }}" required />
    <button class="transition_3" type="submit">–ü–æ—Å—Ç—Ä–æ–∏—Ç—å –≥—Ä–∞—Ñ–∏–∫–∏</button>
    
    {% if error %}
      <div class="error">{{ error }}</div>
    {% endif %}
  </form>

  {% if filename.filename %}
    <div class="filename-display">
      <strong>–¢–µ–∫—É—â–∏–π —Ñ–∞–π–ª:</strong> {{ filename.filename }}
    </div>
  {% endif %}
</div>

{% if results %}
<div class="glass-container results-container">
  <h3 class="text-center">–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∏—Å–ø—ã—Ç–∞–Ω–∏—è</h3>
  <div class="results-grid">
    <div class="result-item">
      <div>–ü—Ä–µ–¥–µ–ª –ø—Ä–æ—á–Ω–æ—Å—Ç–∏ R<sub>m</sub></div>
      <div class="result-value">{{ results.sigma_max_MPa }} –ú–ü–∞</div>
    </div>
    <div class="result-item">
      <div>–û—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ–µ —É–¥–ª–∏–Ω–µ–Ω–∏–µ Œµ<sub>r</sub></div>
      <div class="result-value">{{ results.epsilon_break_percent }} %</div>
    </div>
    {% if results.E_yield_GPa %}
    <div class="result-item">
      <div>–ú–æ–¥—É–ª—å —É–ø—Ä—É–≥–æ—Å—Ç–∏ E</div>
      <div class="result-value">{{ results.E_yield_GPa }} –ì–ü–∞</div>
    </div>
    {% endif %}
    {% if results.sigma_y_MPa %}
    <div class="result-item">
      <div>–ü—Ä–µ–¥–µ–ª —Ç–µ–∫—É—á–µ—Å—Ç–∏ œÉ<sub>y</sub></div>
      <div class="result-value">{{ results.sigma_y_MPa }} –ú–ü–∞</div>
    </div>
    {% endif %}
  </div>
</div>

<div class="glass-container">
  <div class="plot-container" id="plot-container"></div>
</div>
{% endif %}

<div class="glass-container methodology-section">
  <h3 class="name-methodology">–ú–µ—Ç–æ–¥–∏–∫–∞ —Ä–∞—Å—á–µ—Ç–∞ –ø–æ –ì–û–°–¢ 11262-2017</h3>
  
  <h4>1. –û—Å–Ω–æ–≤–Ω—ã–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è:</h4>
  <table class="parameter-table">
    <tr>
      <th>R<sub>m</sub></th>
      <td>–ü—Ä–µ–¥–µ–ª –ø—Ä–æ—á–Ω–æ—Å—Ç–∏ –ø—Ä–∏ —Ä–∞—Å—Ç—è–∂–µ–Ω–∏–∏</td>
      <td>–ú–ü–∞</td>
    </tr>
    <tr>
      <th>Œµ<sub>r</sub></th>
      <td>–û—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ–µ —É–¥–ª–∏–Ω–µ–Ω–∏–µ –ø—Ä–∏ —Ä–∞–∑—Ä—ã–≤–µ</td>
      <td>%</td>
    </tr>
  </table>
  
  <h4>2. –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ–æ—Ä–º—É–ª—ã:</h4>
  <div class="math-formula">
    <p>–ü—Ä–µ–¥–µ–ª –ø—Ä–æ—á–Ω–æ—Å—Ç–∏:</p>
    \[ R_m = \frac{F_m}{A_0} \]
    <p>–≥–¥–µ \( F_m \) - –º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —Å–∏–ª–∞ (–ù), \( A_0 \) - –∏—Å—Ö–æ–¥–Ω–∞—è –ø–ª–æ—â–∞–¥—å —Å–µ—á–µ–Ω–∏—è (–º–º¬≤)</p>
  </div>
  
  <div class="math-formula">
    <p>–û—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ–µ —É–¥–ª–∏–Ω–µ–Ω–∏–µ:</p>
    \[ \varepsilon_r = \frac{L_r - L_0}{L_0} \times 100\% \]
    <p>–≥–¥–µ \( L_0 \) - –Ω–∞—á–∞–ª—å–Ω–∞—è –¥–ª–∏–Ω–∞ –æ–±—Ä–∞–∑—Ü–∞ (–º–º), \( L_r \) - –¥–ª–∏–Ω–∞ –ø—Ä–∏ —Ä–∞–∑—Ä—ã–≤–µ (–º–º)</p>
  </div>
  
  <h4>3. –ê–ª–≥–æ—Ä–∏—Ç–º –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∫–ª—é—á–µ–≤—ã—Ö —Ç–æ—á–µ–∫:</h4>
  <ol class="algorithm-steps">
    <li>–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö (—É–¥–∞–ª–µ–Ω–∏–µ –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π –Ω–∞–≥—Ä—É–∑–∫–∏)</li>
    <li>–ü–æ–∏—Å–∫ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–≥–æ –Ω–∞–ø—Ä—è–∂–µ–Ω–∏—è \( R_m = \max(\sigma) \)</li>
    <li>–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç–æ—á–∫–∏ —Ä–∞–∑—Ä—ã–≤–∞ (–ø–æ—Å–ª–µ–¥–Ω—è—è —Ç–æ—á–∫–∞ –Ω–∞ –∫—Ä–∏–≤–æ–π)</li>
    <li>–†–∞—Å—á–µ—Ç –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ–≥–æ —É–¥–ª–∏–Ω–µ–Ω–∏—è –ø–æ –∏–∑–º–µ–Ω–µ–Ω–∏—é –¥–ª–∏–Ω—ã</li>
  </ol>
  
  <div class="standard-reference">
    * –í—Å–µ —Ä–∞—Å—á–µ—Ç—ã –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–∏ —Å –ì–û–°–¢ 11262-2017 "–ü–ª–∞—Å—Ç–º–∞—Å—Å—ã. –ú–µ—Ç–æ–¥ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –ø—Ä–æ—á–Ω–æ—Å—Ç–∏ –ø—Ä–∏ —Ä–∞—Å—Ç—è–∂–µ–Ω–∏–∏"
  </div>
</div>
{% endblock %}

{% block script %}
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script>
  document.addEventListener("DOMContentLoaded", function() {
    const datasets = {{ datasets|default:"[]"|safe }};
    const layout = {{ layout|default:"{}"|safe }};
    const body = document.body;
    const themeToggle = document.getElementById("themeToggle");

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–µ–∫—É—â–µ–π —Ü–≤–µ—Ç–æ–≤–æ–π —Å—Ö–µ–º—ã
    function getColorScheme() {
      const styles = getComputedStyle(document.body);
      return {
        textColor: styles.getPropertyValue("--text-color").trim(),
        bgColor: styles.getPropertyValue("--box-bg").trim(),
        gridColor: styles.getPropertyValue("--grid-color").trim(),
        accentColor: styles.getPropertyValue("--accent-color").trim()
      };
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –≥—Ä–∞—Ñ–∏–∫–∞
    function getPlotConfig() {
      const colors = getColorScheme();
      return {
        template: body.classList.contains("dark") ? "plotly_dark" : "plotly_white",
        font: {
          color: colors.textColor,
          family: 'Arial, sans-serif'
        },
        plot_bgcolor: colors.bgColor,
        paper_bgcolor: colors.bgColor,
        xaxis: {
          gridcolor: colors.gridColor,
          color: colors.textColor,
          title: {
            font: {
              color: colors.textColor
            }
          }
        },
        yaxis: {
          gridcolor: colors.gridColor,
          color: colors.textColor,
          title: {
            font: {
              color: colors.textColor
            }
          }
        },
        legend: {
          font: {
            color: colors.textColor
          }
        },
        title: {
          font: {
            color: colors.textColor
          }
        }
      };
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–µ–º—ã –≥—Ä–∞—Ñ–∏–∫–∞
    function updatePlotTheme() {
      if (!Plotly || !document.getElementById("plot")) return;
      
      const colors = getColorScheme();
      const update = {
        template: body.classList.contains("dark") ? "plotly_dark" : "plotly_white",
        'font.color': colors.textColor,
        'plot_bgcolor': colors.bgColor,
        'paper_bgcolor': colors.bgColor,
        'xaxis.color': colors.textColor,
        'xaxis.title.font.color': colors.textColor,
        'xaxis.gridcolor': colors.gridColor,
        'yaxis.color': colors.textColor,
        'yaxis.title.font.color': colors.textColor,
        'yaxis.gridcolor': colors.gridColor,
        'legend.font.color': colors.textColor,
        'title.font.color': colors.textColor
      };
      
      Plotly.relayout('plot', update).then(() => {
        // –ü–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –º–∞–∫–µ—Ç–∞, –∏–Ω–æ–≥–¥–∞ –Ω—É–∂–Ω–æ –æ–±–Ω–æ–≤–∏—Ç—å –∏ –¥–∞–Ω–Ω—ã–µ
        Plotly.react('plot', datasets, {...layout, ...update});
      });
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω–æ–≥–æ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –≥—Ä–∞—Ñ–∏–∫–∞
    function drawPlot() {
      if (!datasets || datasets.length === 0) return;
      
      const container = document.getElementById("plot-container");
      container.innerHTML = '<div id="plot" class="plot js-plotly-plot"></div>';
      
      const config = {
        ...getPlotConfig(),
        ...layout,
        responsive: true
      };
      
      Plotly.newPlot('plot', datasets, config);
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Ç–µ–º—ã
    if (themeToggle) {
      themeToggle.addEventListener("click", function() {
        // –î–∞–µ–º –≤—Ä–µ–º—è –Ω–∞ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ CSS-–ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
        setTimeout(() => {
          updatePlotTheme();
        }, 100);
      });
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    drawPlot();
  });
</script>
{% endblock %}